name: Release Please

on:
    push:
        branches:
            - master

permissions:
    contents: write
    pull-requests: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        outputs:
            release_created: ${{ steps.release.outputs.release_created }}
            tag_name: ${{ steps.release.outputs.tag_name }}
            version: ${{ steps.release.outputs.version }}

        steps:
            - name: Release Please
              id: release
              uses: google-github-actions/release-please-action@v4
              with:
                  release-type: node
                  # ä½¿ç”¨ Conventional Commits ä¾†æ±ºå®šç‰ˆæœ¬è™Ÿ
                  # feat: â†’ minor version bump
                  # fix: â†’ patch version bump
                  # feat!: æˆ– BREAKING CHANGE â†’ major version bump

    # ç•¶ Release PR è¢«åˆä½µä¸¦å‰µå»º release å¾Œï¼ŒåŸ·è¡Œ build å’Œæ¸¬è©¦
    build-and-verify:
        needs: release-please
        if: ${{ needs.release-please.outputs.release_created }}
        runs-on: ubuntu-latest

        steps:
            # 1ï¸âƒ£ Checkout repository
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            # 2ï¸âƒ£ Install pnpm
            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            # 3ï¸âƒ£ Setup Node.js
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "pnpm"

            # 4ï¸âƒ£ Install dependencies
            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # 5ï¸âƒ£ Build
            - name: Build
              run: pnpm build

            # 6ï¸âƒ£ Run tests
            - name: Test
              run: pnpm test:run

            # 7ï¸âƒ£ Run coverage tests
            - name: Test Coverage
              run: pnpm test:coverage:ci

            # 8ï¸âƒ£ Verify version consistency
            - name: Verify version consistency
              run: |
                  VERSION="${{ needs.release-please.outputs.version }}"
                  PKG_VERSION=$(node -e "console.log(require('./package.json').version)")
                  echo "Release version: $VERSION"
                  echo "package.json version: $PKG_VERSION"
                  if [ "$PKG_VERSION" != "$VERSION" ]; then
                      echo "âŒ Error: Version mismatch!"
                      exit 1
                  fi
                  echo "âœ… Version consistency verified"

            - name: Release successful
              run: |
                  echo "ğŸ‰ Release ${{ needs.release-please.outputs.tag_name }} verified successfully!"
                  echo "Version: ${{ needs.release-please.outputs.version }}"
