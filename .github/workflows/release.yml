name: Release

on:
    push:
        tags:
            - "v*.*.*"

jobs:
    release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            # 1ï¸âƒ£ Checkout repository
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            # 2ï¸âƒ£ Install pnpm (must be before Node.js setup)
            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10.20.0

            # 3ï¸âƒ£ Setup Node.js
            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 20
                  cache: "pnpm"

            # 4ï¸âƒ£ Install dependencies
            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            # 5ï¸âƒ£ Build
            - name: Build
              run: pnpm build

            # 6ï¸âƒ£ Run tests
            - name: Test
              run: pnpm test:run

            # 7ï¸âƒ£ Run coverage tests with thresholds (required before release)
            - name: Test Coverage
              run: pnpm test:coverage:ci

            # 8ï¸âƒ£ Extract version from tag
            - name: Extract version from tag
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Released version: $VERSION"
                  echo "Note: Version is managed by npm version command, ensuring package.json, commit, and tag are always in sync"

            # 9ï¸âƒ£ Verify version consistency
            - name: Verify version consistency
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  PKG_VERSION=$(node -e "console.log(require('./package.json').version)")
                  echo "Tag version: $VERSION"
                  echo "package.json version: $PKG_VERSION"
                  if [ "$PKG_VERSION" != "$VERSION" ]; then
                      echo "âŒ Error: Version mismatch! package.json ($PKG_VERSION) does not match tag ($VERSION)"
                      echo "This should not happen when using npm version command."
                      exit 1
                  fi
                  echo "âœ… Version consistency verified (package.json, commit, and tag are in sync)"

            # ğŸ”Ÿ Create GitHub Release
            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  name: Release ${{ steps.version.outputs.version }}
                  body: |
                      ## Changes in ${{ steps.version.outputs.version }}

                      See [CHANGELOG.md](../../CHANGELOG.md) for details.
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # 1ï¸âƒ£1ï¸âƒ£ Create PR to bump version
            - name: Calculate next version
              id: next_version
              run: |
                  CURRENT_VERSION="${{ steps.version.outputs.version }}"
                  # Parse version components
                  IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
                  MAJOR="${VERSION_PARTS[0]}"
                  MINOR="${VERSION_PARTS[1]}"
                  PATCH="${VERSION_PARTS[2]}"

                  # Increment patch version
                  NEXT_PATCH=$((PATCH + 1))
                  NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"

                  echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
                  echo "Current version: $CURRENT_VERSION"
                  echo "Next version: $NEXT_VERSION"

            - name: Update package.json version
              run: |
                  npm version "${{ steps.next_version.outputs.next_version }}" --no-git-tag-version

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: chore/bump-version-to-${{ steps.next_version.outputs.next_version }}
                  base: master
                  title: "chore: bump version to ${{ steps.next_version.outputs.next_version }}"
                  body: |
                      ## ç‰ˆæœ¬æ›´æ–°

                      è‡ªå‹•å»ºç«‹æ­¤ PR ä»¥æº–å‚™ä¸‹ä¸€å€‹ç‰ˆæœ¬è™Ÿï¼š**${{ steps.next_version.outputs.next_version }}**

                      ### è®Šæ›´å…§å®¹
                      - æ›´æ–° `package.json` ç‰ˆæœ¬è™Ÿï¼š`${{ steps.version.outputs.version }}` â†’ `${{ steps.next_version.outputs.next_version }}`

                      ### æ³¨æ„äº‹é …
                      - æ­¤ PR ç”± Release workflow è‡ªå‹•å»ºç«‹
                      - åˆä½µæ­¤ PR å¾Œå³å¯é–‹å§‹æº–å‚™ä¸‹ä¸€å€‹ç‰ˆæœ¬çš„é–‹ç™¼
                      - ç‰ˆæœ¬è™Ÿå·²è‡ªå‹•å¢åŠ  patch ç‰ˆæœ¬ï¼ˆ`${{ steps.version.outputs.version }}` â†’ `${{ steps.next_version.outputs.next_version }}`ï¼‰
                  labels: |
                      chore
                      automated
                  draft: false
                  commit-message: "chore: bump version to ${{ steps.next_version.outputs.next_version }}"
